<html lang="pt-br">
    <head>
        <link rel="stylesheet" href="icones/style.css">
        <script src="js/script.js" defer></script>
        <meta charset="UTF-8">

    
        <style>
        
            body{
                margin: 0;
                padding: 0;
            }
        
            ul{
                list-style-type: none;
                display: inline-block;
                margin: 0;
                padding: 0;
            }
            ul li{
                float: right;
                margin: 2px 5px 0px 5px;
                color: white;
                text-shadow: 1px 1px 1px black;
            }
        
            span:hover{
                cursor: pointer;
            }
        
            .bottom{
                background-color:rgb(0, 68, 110);
                border-radius: 0px 0px 10px 10px;
                position: relative;
            }
        
            iframe{
                width: 410px;
                height: 280px;
                resize: none;
                border-radius: 10px 10px 0px 0px;
                padding: 10px;
                font-size: 1.2em;
                background-color: white;
                overflow-x: hidden;
            }

            .salvar{
                position: absolute;
                right: 15px;
            }

            abbr{
                text-decoration: none;
            }

        </style>
    </head>
    <body>
        <div class="tudo">
            <iframe src="about:blank" frameborder="0" contenteditable="true" name="texto_iframe" id="text_iframe"></iframe>
            <div class="bottom">
                <ul>
                    <li class=""><abbr title="Salvar (Shift Right)"><span class="icon-checkmark salvar"></span></abbr></li>
                    
                    <li class=""><abbr title="Alinhar à Direita"><span class="icon-paragraph-right" onclick="alinhar_direita()"></span></abbr></li>

                    <li class=""><abbr title="Alinhar no Centro"><span class="icon-paragraph-center" onclick="alinhar_centro()"></span></abbr></li>

                    <li class=""><abbr title="Justificar"><span class="icon-paragraph-justify" onclick="justificar()"></span></abbr></li>

                    <li class=""><abbr title="Alinhar à Esquerda"><span class="icon-paragraph-left" onclick="alinhar_esquerda()"></span></abbr></li>

                    <li class=""><abbr title="Sublinhado"><span class="icon-underline" onclick="sublinhado()"></span></abbr></li>

                    <li class=""><abbr title="Tachado"><span class="icon-strikethrough" onclick="tachado()"></span></abbr></li>

                    <li class=""><abbr title="Itálico"><span class="icon-italic" onclick="italico()"></span></abbr></li>

                    <li  class="negrito"><abbr title="Negrito"><span class="icon-bold" onclick="bold()"></span></abbr></li>
                </ul>
            </div>
        </div>
        <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>

        <script>
            const text_area = document.querySelector('.caixa-texto');
            const btn_salvar = document.querySelector('.salvar');
            const iframe = document.getElementById("text_iframe")
            texto_iframe.document.designMode = 'on';
            const iframe_window = iframe.contentWindow;
            var valor = -1;
            

            iframe_window.document.body.style = 'font-family: monospace;';

            // ------------------------- QUEBRA DE LINHA ------------------

            texto_iframe.addEventListener("keydown",function(e){
                if(e.code == 'ShiftRight'){
                    salvar();
                }
                else if(e.key == 'Enter'){
                    valor--;
                }
                else if(e.key == 'Dead'){
                    valor--;
                }
                else if(e.key == 'Shift'){
                    valor--;
                }
                else if(e.key == 'Tab'){
                    valor--;
                }
                else if(e.key == 'CapsLock'){
                    valor--;
                }
                else if(e.key == 'Backspace'){
                    valor--;
                }
                else if(e.key == 'Control'){
                    texto_iframe.addEventListener("keydown",function(el){
                        if(el.key == 'v'){
                            texto_iframe.document.execCommand('justifyCenter', false, null);
                        }
                    })
                }
            });

            //----------------------- SALVAR NOTA -----------------

            btn_salvar.addEventListener('click',salvar);

            function salvar(){

            var dados = new FormData();

            var texto_bruto = iframe_window.document.body.innerHTML.toString();

            var tratamento1 = texto_bruto.replace(/<div>/gi, '<br>');
            finaldiv = new RegExp('</div>', 'gi');
            var tratamento2 = tratamento1.replace(finaldiv, '');

            dados.append('nota', tratamento2);
            dados.append('ocasiao', new Date());

            $.ajax({
                url: 'index.php',
                method: 'post',
                data: dados,
                processData: false,
                contentType: false,
                success: function(resposta){
                    console.log(resposta);
                }
            })

            iframe_window.document.body.innerHTML = '';
            location.reload();

            }

            //-------------------- NEGRITO - ITÁLICO ----------------

            // texto_iframe.document.designMode = 'on';

            var bold = function(){
                texto_iframe.document.execCommand('bold', false, null);
            }

            var italico = function(){
                texto_iframe.document.execCommand('italic', false, null);
            }

            var sublinhado = function(){
                texto_iframe.document.execCommand('underline', false, null);
            }

            var tachado = function(){
                texto_iframe.document.execCommand('strikeThrough', false, null);
            }

            var alinhar_direita = function(){
                texto_iframe.document.execCommand('justifyRight', false, null);
            }

            var alinhar_esquerda = function(){
                texto_iframe.document.execCommand('justifyLeft', false, null);
            }

            var justificar = function(){
                texto_iframe.document.execCommand('justifyFull', false, null);
            }

            var alinhar_centro = function(){
                texto_iframe.document.execCommand('justifyCenter', false, null);
            }

            //--------------------- QUEBRAR LINHA IFRAME ------------------

            texto_iframe.addEventListener("keydown",quebrar_linha);

            function quebrar_linha(){
                valor++;
                while(valor == 55){
                    texto_iframe.document.execCommand('insertParagraph', false, null);
                    valor = 0;
                }
            }

        </script>
    </body>
</html>